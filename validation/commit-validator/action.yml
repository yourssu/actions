name: "Yourssu Commit Validator"
description: "Validate commit messages in a pull request against naming conventions"
author: "Yourssu Backend Team"

inputs:
  github_token:
    description: "GitHub token for API access"
    required: false
    default: ${{ github.token }}
  pr_number:
    description: "Pull request number to validate commits for"
    required: false
    default: ${{ github.event.number }}
  team_config:
    description: "Predefined team configuration (yourssu-backend, etc.)"
    required: false
    default: "yourssu-backend"
  config_file:
    description: "Path to custom configuration file"
    required: false
    default: ".github/naming-convention.yml"

outputs:
  is_valid:
    description: "Whether all commit messages are valid"
    value: ${{ steps.validate.outputs.is_valid }}
  result_message:
    description: "Validation result message"
    value: ${{ steps.validate.outputs.result_message }}
  invalid_commits:
    description: "JSON array of invalid commits"
    value: ${{ steps.validate.outputs.invalid_commits }}
  total_commits:
    description: "Total number of commits checked"
    value: ${{ steps.validate.outputs.total_commits }}

runs:
  using: "composite"
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "20"

    - name: Install dependencies
      shell: bash
      run: npm install js-yaml

    - name: Validate commit messages
      id: validate
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github_token }}
        script: |
          const yaml = require('js-yaml');
          const fs = require('fs');
          const https = require('https');

          // Get PR number
          const prNumber = '${{ inputs.pr_number }}' || context.issue.number;
          
          console.log(`ğŸ” Validating commit messages for PR #${prNumber}`);

          // Get commits from the PR
          let commits;
          try {
            const response = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            commits = response.data;
          } catch (error) {
            console.error('âŒ Failed to fetch commits:', error);
            core.setOutput('is_valid', 'false');
            core.setOutput('result_message', 'âŒ PR ì»¤ë°‹ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            core.setOutput('invalid_commits', '[]');
            core.setOutput('total_commits', '0');
            return;
          }

          // Load configuration
          let config;
          const configFile = '${{ inputs.config_file }}';
          const teamConfig = '${{ inputs.team_config }}';
          
          if (teamConfig && teamConfig !== '') {
            // Use team config - download it
            const configUrl = `https://raw.githubusercontent.com/yourssu/actions/main/validation/validator/configs/${teamConfig}.yml`;
            
            console.log(`ğŸ“‹ Loading team config: ${teamConfig}`);
            
            try {
              const response = await new Promise((resolve, reject) => {
                https.get(configUrl, (res) => {
                  let data = '';
                  res.on('data', chunk => data += chunk);
                  res.on('end', () => resolve(data));
                }).on('error', reject);
              });
              
              config = yaml.load(response);
              console.log('âœ… Team configuration loaded successfully');
            } catch (error) {
              console.error('âŒ Failed to load team config:', error);
              core.setOutput('is_valid', 'false');
              core.setOutput('result_message', 'âŒ íŒ€ ì„¤ì •ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              core.setOutput('invalid_commits', '[]');
              core.setOutput('total_commits', commits.length.toString());
              return;
            }
          } else {
            // Use local config file
            console.log(`ğŸ“‹ Loading local config: ${configFile}`);
            
            try {
              const fileContent = fs.readFileSync(configFile, 'utf8');
              config = yaml.load(fileContent);
              console.log('âœ… Local configuration loaded successfully');
            } catch (error) {
              console.error('âŒ Failed to load local config:', error);
              core.setOutput('is_valid', 'false');
              core.setOutput('result_message', 'âŒ ì„¤ì • íŒŒì¼ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              core.setOutput('invalid_commits', '[]');
              core.setOutput('total_commits', commits.length.toString());
              return;
            }
          }

          // Validate commit messages
          const allowedTags = config.tags?.allowed || [];
          const patternString = config.patterns.commit_message.replace('{tags}', allowedTags.join('|'));
          
          let pattern;
          try {
            pattern = new RegExp(patternString);
            console.log(`ğŸ“‹ Using regex pattern: ${patternString}`);
          } catch (error) {
            console.error('âŒ Invalid regex pattern:', error);
            core.setOutput('is_valid', 'false');
            core.setOutput('result_message', 'âŒ ì •ê·œì‹ íŒ¨í„´ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.');
            core.setOutput('invalid_commits', '[]');
            core.setOutput('total_commits', commits.length.toString());
            return;
          }
          
          const invalidCommits = [];
          let processedCount = 0;
          
          for (const commit of commits) {
            const message = commit.commit.message.split('\n')[0]; // Get first line only
            processedCount++;
            
            // Skip merge commits
            if (message.startsWith('Merge ')) {
              console.log(`â­ï¸  Skipping merge commit: ${commit.sha.substring(0, 7)}`);
              continue;
            }
            
            if (!pattern.test(message)) {
              console.log(`âŒ Invalid commit: ${commit.sha.substring(0, 7)} - "${message}"`);
              invalidCommits.push({
                sha: commit.sha.substring(0, 7),
                full_sha: commit.sha,
                message: message,
                author: commit.commit.author.name,
                date: commit.commit.author.date
              });
            } else {
              console.log(`âœ… Valid commit: ${commit.sha.substring(0, 7)} - "${message}"`);
            }
          }
          
          const isValid = invalidCommits.length === 0;
          
          // Set outputs
          core.setOutput('is_valid', isValid.toString());
          core.setOutput('invalid_commits', JSON.stringify(invalidCommits));
          core.setOutput('total_commits', processedCount.toString());
          
          // Create result message
          if (isValid) {
            const message = `âœ… **ëª¨ë“  ì»¤ë°‹ ë©”ì‹œì§€ê°€ ë„¤ì´ë° ì»¨ë²¤ì…˜ì„ ë”°ë¦…ë‹ˆë‹¤.**\n\nê²€ì¦ëœ ì»¤ë°‹: ${processedCount}ê°œ`;
            core.setOutput('result_message', message);
            console.log(`ğŸ‰ All ${processedCount} commits are valid!`);
          } else {
            let errorMessage = `âŒ **ë‹¤ìŒ ${invalidCommits.length}ê°œì˜ ì»¤ë°‹ ë©”ì‹œì§€ê°€ ë„¤ì´ë° ì»¨ë²¤ì…˜ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:**\n\n`;
            
            invalidCommits.forEach(commit => {
              errorMessage += `- \`${commit.sha}\`: \`${commit.message}\`\n`;
            });
            
            errorMessage += `\n**ì˜¬ë°”ë¥¸ í˜•ì‹:** \`${patternString}\`\n`;
            errorMessage += '**ì‚¬ìš© ê°€ëŠ¥í•œ íƒœê·¸:** ' + allowedTags.join(', ') + '\n\n';
            errorMessage += '**ì˜¬ë°”ë¥¸ ì˜ˆì‹œ:**\n';
            
            if (config.examples?.commit_examples) {
              config.examples.commit_examples.forEach(example => {
                errorMessage += `- \`${example}\`\n`;
              });
            }
            
            errorMessage += `\nğŸ“Š **ê²€ì¦ ê²°ê³¼:** ${processedCount - invalidCommits.length}/${processedCount} í†µê³¼`;
            
            core.setOutput('result_message', errorMessage);
            console.log(`âŒ ${invalidCommits.length}/${processedCount} commits failed validation`);
          }